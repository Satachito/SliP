<!DOCTYPE HTML>
<html lang=zxx>
<title>SliP, the monster calculator.</title>
<style>
button, input, select, textarea {
;	font-family				: inherit
;	font-size				: 100%
}
html {
;	height					: 100%
}
body {
;	height					: 100%
;	margin					: 0
;	display					: grid
;	grid-template-rows		: auto 1fr auto
;	grid-template-columns	: auto 1fr auto
}
header {
;	grid-column				: 1 / 4
;	border-bottom			: 1px solid black
;	padding					: 6px
;	font-family				: fantasy
}
footer {
;	grid-column				: 1 / 4
;	border-top				: 1px solid black
;	padding					: 6px
;	font-family				: cursive
}
nav {
;	border-right			: 1px solid black
;	padding					: 6px
;	font-family				: monospace
;	overflow				: scroll
}
aside {
;	border-left				: 1px solid black
;	padding					: 6px
;	font-family				: monospace
;	overflow				: scroll
}
jp-split-h {
;	font-family				: monospace
;	font-size				: 12px
;	overflow				: scroll
}
jp-split-h > * {
;	background-color		: #ffe
}
textarea {
;	resize					: none
;	border					: none
}
#GUTTER {
;	background				: lightgrey
;	cursor					: col-resize
}
#RESULT {
;	padding					: 6px
}
.hw24 {
;	height					: 32px
;	width					: 32px
}
.hw16 {
;	padding					: 0
;	height					: 24px
;	width					: 20px
}
.w56 {
;	padding					: 0
;	width					: 56px
}
.w24 {
;	padding					: 0
;	width					: 24px
</style>

<header style="display: grid; grid-template-columns: auto 1fr auto">
       SliP, the monster calculator.
       <div></div>
       <a href=Tutorial.html target=_blank>Tutorial</a>
</header>

<nav>
	<input type=button style="height:32px; width:100%" value=CALCULATE	id=CALCULATE><br>
	<br>
	<input type=button class="di hw24" value=7>
	<input type=button class="di hw24" value=8>
	<input type=button class="di hw24" value=9>
	<input type=button class="di hw24" value=÷><br>
	<input type=button class="di hw24" value=4>
	<input type=button class="di hw24" value=5>
	<input type=button class="di hw24" value=6>
	<input type=button class="di hw24" value=×><br>
	<input type=button class="di hw24" value=1>
	<input type=button class="di hw24" value=2>
	<input type=button class="di hw24" value=3>
	<input type=button class="di hw24" value=-><br>
	<input type=button class="di hw24" value=0>
	<input type=button class="di hw24" value=.>
	<input type=button class="   hw24" value=⏎	id=KEY_RET	>
	<input type=button class="di hw24" value=+><br>
	<input type=button class="di hw24" value=(>
	<input type=button class="di hw24" value=)>
	<input type=button class="di hw24" value=%>
	<input type=button class="   hw24" value=C	id=CLEAR	><br>
	<br>
	<input type=button style="height:32px; width:100%" value=SPACE id=KEY_SPACE><br>
	<br>
	<input type=button class="di hw16"	value=π>
	<input type=button class="di hw16"	value=e>
	<input type=button class="di hw16"	value=∞><br>
	<br>
	<input type=button class="di w56" value=sin()>
	<input type=button class="di w56" value=cos()>
	<input type=button class="di w56" value=tan()><br>
	<input type=button class="di w56" value=log()>
	<input type=button class="di w56" value=exp()>
	<input type=button class="di w56" value=sqrt()><br>
	<input type=button class="di w56" value=atan2[]>
	<input type=button class="di w56" value=pow[]>
	<input type=button class="di w56" value=random><br>
	<br>
	<input type=button class="di w56" value=asin()>
	<input type=button class="di w56" value=acos()>
	<input type=button class="di w56" value=atan()><br>

	<input type=button class="di w56" value=sinh()>
	<input type=button class="di w56" value=cosh()>
	<input type=button class="di w56" value=tanh()><br>

	<input type=button class="di w56" value=asinh()>
	<input type=button class="di w56" value=acosh()>
	<input type=button class="di w56" value=atanh()><br>

	<input type=button class="di w56" value=round()>
	<input type=button class="di w56" value=ceil()>
	<input type=button class="di w56" value=floor()><br>
	<input type=button class="di w56" value=abs()>
	<input type=button class="di w56" value=trunc()>
	<input type=button class="di w56" value=sign()><br>
	<input type=button class="di w56" value=cbrt()>
	<input type=button class="di w56" value=log2()>
	<input type=button class="di w56" value=log10()><br>
	<input type=button class="di w56" value=hypot[]>
	<input type=button class="di w56" value=max[]>
	<input type=button class="di w56" value=min[]><br>

	<div id=PROGRAMMING_KEYS style="display: none">
		<br>
		<input type=button class="di hw16" value=α>
		<input type=button class="di hw16" value=β>
		<input type=button class="di hw16" value=γ>
		<input type=button class="di hw16" value=δ>
		<input type=button class="di hw16" value=ε>
		<input type=button class="di hw16" value=ζ><br>
		<input type=button class="di hw16" value=η>
		<input type=button class="di hw16" value=θ>
		<input type=button class="di hw16" value=ι>
		<input type=button class="di hw16" value=κ>
		<input type=button class="di hw16" value=λ>
		<input type=button class="di hw16" value=μ><br>
		<input type=button class="di hw16" value=ν>
		<input type=button class="di hw16" value=ξ>
		<input type=button class="di hw16" value=ο>
		<input type=button class="di hw16" value=π>
		<input type=button class="di hw16" value=ρ>
		<input type=button class="di hw16" value=ς>
		<input type=button class="di hw16" value=σ><br>
		<input type=button class="di hw16" value=τ>
		<input type=button class="di hw16" value=υ>
		<input type=button class="di hw16" value=φ>
		<input type=button class="di hw16" value=χ>
		<input type=button class="di hw16" value=ψ>
		<input type=button class="di hw16" value=ω><br>
		<br>
		<input type=button class="di w24" value=&>		Bit and<br>
		<input type=button class="di w24" value=|>		Bit or<br>
		<input type=button class="di w24" value=^>		Bit xor<br>
		<input type=button class="di w24" value=~>		Bit not<br>
		<input type=button class="di w24" value=&&>		Logical and<br>
		<input type=button class="di w24" value=||>		Logical or<br>
		<input type=button class="di w24" value=^^>		Logical or<br>
		<input type=button class="di w24" value=¬>		Logical not<br>

		<input type=button class="di w24" value=·>		Inner product<br>

		<input type=button class="di w24" value=.>		Console.log<br>
		<input type=button class="di w24" value=¦>		Console.error<br>

		<input type=button class="di w24" value="==">	Equal<br>
		<input type=button class="di w24" value="<>">	Not equal<br>
		<input type=button class="di w24" value="<">	Less than<br>
		<input type=button class="di w24" value="<=">	Less equal<br>
		<input type=button class="di w24" value=">">	Greater than<br>
		<input type=button class="di w24" value=">=">	Greater equal<br>

		<input type=button class="di w24" value=∈>		Member of<br>
		<input type=button class="di w24" value=∋>		Include<br>

		<input type=button class="di w24" value='""'>	String<br>
		<input type=button class="di w24" value=``>		String<br>

		<input type=button class="di w24" value=[]>		List<br>
		<input type=button class="di w24" value={}>		Procedure evaluation<br>
		<input type=button class="di w24" value=«»>		Parallel evaluation<br>

		<input type=button class="di w24" value=#>		# of items in list<br>
		<input type=button class="di w24" value=$>		The last item of list<br>
		<input type=button class="di w24" value=*>		Lisp's cdr<br>
		<input type=button class="di w24" value=,>		Insert L at the top of R<br>

		<input type=button class="di w24" value=¶>		Stringify<br>
		<input type=button class="di w24" value="=">	Assign<br>

		<input type=button class="di w24" value=!>		Eval<br>
		<input type=button class="di w24" value="'">	Quote<br>
		<input type=button class="di w24" value=¡>		Throw<br>
		<input type=button class="di w24" value=@>		Stack top<br>
		<input type=button class="di w24" value=¿>		If<br>
		<input type=button class="di w24" value=?>		If else<br>
		<input type=button class="di w24" value=§>		Evaluate R in context L<br>
		<input type=button class="di w24" value=¤>		Current context dictionay<br>
		<input type=button class="di w24" value=:>		Apply<br>
		<br>
		<input type=button class="di hw16" value=Α>
		<input type=button class="di hw16" value=Β>
		<input type=button class="di hw16" value=Γ>
		<input type=button class="di hw16" value=Δ>
		<input type=button class="di hw16" value=Ε>
		<input type=button class="di hw16" value=Ζ><br>
		<input type=button class="di hw16" value=Η>
		<input type=button class="di hw16" value=Θ>
		<input type=button class="di hw16" value=Ι>
		<input type=button class="di hw16" value=Κ>
		<input type=button class="di hw16" value=Λ>
		<input type=button class="di hw16" value=Μ><br>
		<input type=button class="di hw16" value=Ν>
		<input type=button class="di hw16" value=Ξ>
		<input type=button class="di hw16" value=Ο>
		<input type=button class="di hw16" value=Π>
		<input type=button class="di hw16" value=Ρ>
		<input type=button class="di hw16" value=Σ><br>
		<input type=button class="di hw16" value=Τ>
		<input type=button class="di hw16" value=Υ>
		<input type=button class="di hw16" value=Φ>
		<input type=button class="di hw16" value=Χ>
		<input type=button class="di hw16" value=Ψ>
		<input type=button class="di hw16" value=Ω><br>
		<br>
	</div>
	<br>
</nav>

<jp-split-h grid-template="1fr 6px 1fr">
	<textarea id=SOURCE></textarea>
	<div id=GUTTER></div>
	<div id=RESULT style="overflow: scroll"></div>
</jp-split-h>

<aside>
	When INPUT<br>
	<label for=CONV_ASTERISK	><input type=checkbox id=CONV_ASTERISK	checked	> * → ×				</label><br>
	<label for=CONV_SLASH		><input type=checkbox id=CONV_SLASH		checked	> / → ÷				</label><br>
	<br>
	When CALCULATE<br>
	<label for=PROGRAM_MODE		><input type=checkbox id=PROGRAM_MODE			> Programming mode	</label><br>
	<label for=CONV_X			><input type=checkbox id=CONV_X					> x,X → ×			</label><br>
	<br>
	When OUTPUT<br>
	<label for=INCLUDE_SOURCE	><input type=checkbox id=INCLUDE_SOURCE	checked> Include source	</label><br>
	<br>
</aside>

<footer>Copyright 2022 SliP LLC, Tokyo.</footer>

<script type=module>
CLEAR		.onclick = () => ( SOURCE.value = '', SOURCE.focus() )
const
InsertToSOURCE = _ => {
	const $ = SOURCE.selectionStart
	SOURCE.value = SOURCE.value.substring( 0, $ ) + _ + SOURCE.value.substring( SOURCE.selectionEnd )
	setTimeout( () => SOURCE.selectionStart = SOURCE.selectionEnd = $ + _.length )
	SOURCE.focus()
}
KEY_RET		.onclick = () => InsertToSOURCE( '\n' )
KEY_SPACE	.onclick = () => InsertToSOURCE( ' ' )
document.querySelectorAll( 'input.di' ).forEach( _ => _.onclick = () => InsertToSOURCE( _.value ) )

SOURCE.onkeydown = ev => {
	if ( ev.metaKey ) return
	switch ( ev.key ) {
	case '*':
		CONV_ASTERISK.checked && (
			ev.preventDefault()
		,	InsertToSOURCE( '×' )
		)
		break
	case '/':
		CONV_SLASH.checked && (
			ev.preventDefault()
		,	InsertToSOURCE( '÷' )
		)
		break
	}
}

const
AppendDIV = text => {
	const $ = RESULT.appendChild( document.createElement( 'div' ) )
	$.textContent = text
	return $
}

window.onbeforeunload = () => localStorage.setItem( 'SOURCE', SOURCE.value )

const
SyncProgrammingKeys = () => PROGRAMMING_KEYS.style.display = PROGRAM_MODE.checked ? 'block' : 'none'

PROGRAM_MODE.onchange = SyncProgrammingKeys

window.onload = () => (
	SOURCE.value = localStorage.getItem( 'SOURCE' )
,	SyncProgrammingKeys()
)

import { NewContext, StringReader, Read, Eval, Sugared } from './SliP.js'

const
TreatEX = ex => (
	console.error( ex )
,	Array.isArray( ex )
	?	ex.forEach( _ => AppendDIV( _ ).style.color = 'red' )
	:	AppendDIV( ex ).style.color = 'red'
)
CALCULATE.onclick = () => {

	const c = NewContext()

	RESULT.textContent = ''

	let source = SOURCE.value
	CONV_X.checked && ( source = source.replaceAll( /[xX]/, '×' ) )

	if ( PROGRAM_MODE.checked ) {
		source = source.split( '\n' ).map(
			_ => {
				const index = _.indexOf( '//' )
				return ( index < 0 ? _ : _.substring( 0, index ) ).trim()
			}
		).join( '\n' )
		const $ = new StringReader( source )
		while ( true ) {
			const start = $._
			const _ = Read( $ )
			if ( !_ ) break
			INCLUDE_SOURCE.checked && ( AppendDIV( source.substring( start, $._ ) ).style.color = 'grey' )
			try {
				AppendDIV( Eval( c, _ ).string() )
			} catch ( ex ) {
				TreatEX( ex )
			}
		}
	} else {
		source.split( '\n' ).map(
			_ => {
				INCLUDE_SOURCE.checked && (
					_.length
					?	( AppendDIV( _ ).style.color = 'grey' )
					:	RESULT.appendChild( document.createElement( 'br' ) )
				)
				const index = _.indexOf( '//' )
				const $ = ( index < 0 ? _ : _.substring( 0, index ) ).trim()
				if ( $.length ) {
					try {
						AppendDIV( Eval( c, Sugared( _ ) ).string() )
					} catch ( ex ) {
						TreatEX( ex )
					}
				}
			}
		)
	}
}

</script>

<script src=./jp-split/jp-split.js></script>

